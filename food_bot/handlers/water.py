from aiogram.filters import Command
from aiogram.types import Message
from aiogram import Router

from memory import ensure_user, ensure_day, today_key

router = Router()


@router.message(Command("log_water"))
async def log_water(message: Message):
    """
    ## /log_water

    –õ–æ–≥–∏—Ä—É–µ—Ç –≤—ã–ø–∏—Ç—É—é –≤–æ–¥—É –∑–∞ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —Å–∫–æ–ª—å–∫–æ –æ—Å—Ç–∞–ª–æ—Å—å –¥–æ –Ω–æ—Ä–º—ã.

    ### –§–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã
    `/log_water <–º–ª>`

    –ü—Ä–∏–º–µ—Ä: `/log_water 250`

    ### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
    1. –ü–æ–ª—É—á–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ `ensure_user`.
    2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –ø—Ä–æ—Ñ–∏–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–µ—Å—Ç—å `water_goal`), –∏–Ω–∞—á–µ –ø—Ä–æ—Å–∏—Ç `/set_profile`.
    3. –ü–∞—Ä—Å–∏—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∏–ª–ª–∏–ª–∏—Ç—Ä–æ–≤ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –¥–∏–∞–ø–∞–∑–æ–Ω.
    4. –û–±–Ω–æ–≤–ª—è–µ—Ç –¥–Ω–µ–≤–Ω–æ–π –ª–æ–≥ –≤–æ–¥—ã: `day["water"] += ml`.
    5. –°—á–∏—Ç–∞–µ—Ç –æ—Å—Ç–∞—Ç–æ–∫ –¥–æ –Ω–æ—Ä–º—ã —Å —É—á—ë—Ç–æ–º –¥–æ–±–∞–≤–∫–∏ –≤–æ–¥—ã –æ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ (`burned_water`).
    6. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏ –æ—Å—Ç–∞—Ç–æ–∫.

    ### –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–≤–æ–¥–∞
    - –ó–Ω–∞—á–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º.
    - –î–∏–∞–ø–∞–∑–æ–Ω: `(0..5000]` (1‚Äì5000 –º–ª).

    ### –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–æ–ª—è
    - `user["water_goal"]` ‚Äî –¥–Ω–µ–≤–Ω–∞—è —Ü–µ–ª—å –≤–æ–¥—ã (–º–ª).
    - `user["burned_water"]` ‚Äî –¥–æ–±–∞–≤–∫–∞ –≤–æ–¥—ã –æ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∑–∞ —Å–µ–≥–æ–¥–Ω—è (–º–ª).
    - `day["water"]` ‚Äî —Å–∫–æ–ª—å–∫–æ –≤–æ–¥—ã –≤—ã–ø–∏—Ç–æ –∑–∞ –¥–µ–Ω—å (–º–ª).

    ### –ö–∞–∫ —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ—Å—Ç–∞—Ç–æ–∫
    ```text
    left = max(0, water_goal - drank_today + burned_water)
    ```
    –ì–¥–µ:
    - `water_goal` ‚Äî –±–∞–∑–æ–≤–∞—è —Ü–µ–ª—å –≤–æ–¥—ã,
    - `drank_today` ‚Äî –≤—ã–ø–∏—Ç–∞—è –≤–æ–¥–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è (`day["water"]`),
    - `burned_water` ‚Äî –¥–æ–±–∞–≤–∫–∞ –≤–æ–¥—ã –æ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ (–µ—Å–ª–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –±—ã–ª–∏).

    ### –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    –ü—Ä–∏–º–µ—Ä:
    `üíß –ó–∞–ø–∏—Å–∞–Ω–æ: 250 –º–ª.
     –û—Å—Ç–∞–ª–æ—Å—å –¥–æ –Ω–æ—Ä–º—ã: 900 –º–ª.`
    """
    user = ensure_user(message.from_user.id)
    if not user.get("water_goal"):
        return await message.answer("–°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å: /set_profile")

    parts = message.text.split(maxsplit=1)
    if len(parts) < 2:
        return await message.answer("–§–æ—Ä–º–∞—Ç: /log_water <–º–ª>  (–Ω–∞–ø—Ä–∏–º–µ—Ä /log_water 250)")

    try:
        ml = int(parts[1])
        if ml <= 0 or ml > 5000:
            raise ValueError
    except Exception:
        return await message.answer("–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–ª —á–∏—Å–ª–æ–º, –Ω–∞–ø—Ä–∏–º–µ—Ä /log_water 250")

    user["logged_water"] += ml

    day = ensure_day(user, today_key())
    day["water"] = user["logged_water"]

    left = max(0, user["water_goal"] - user["logged_water"] + user["burned_water"])
    await message.answer(f"üíß –ó–∞–ø–∏—Å–∞–Ω–æ: {ml} –º–ª.\n–û—Å—Ç–∞–ª–æ—Å—å –¥–æ –Ω–æ—Ä–º—ã: {left} –º–ª.")
